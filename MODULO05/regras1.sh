#!/bin/bash

# Declara variaveis
IPTABLES=/sbin/iptables
NET1=eth0
WAN1=eth1


# Cria Chains
$IPTABLES -N SSH
$IPTABLES -N DNS
$IPTABLES -N HTTP
$IPTABLES -N HTTPs
$IPTABLES -N LogAcceptSSH
$IPTABLES -N LogAcceptDNS
$IPTABLES -N LogAcceptHTTP
$IPTABLES -N LogAcceptHTTPs
$IPTABLES -N LogDrop

# Libera interface de Loopback
$IPTABLES -A INPUT -i lo -j ACCEPT
$IPTABLES -A OUTPUT -o lo -j ACCEPT

# Liberar entrada e saida SSH e gera log SSH
$IPTABLES -A INPUT -i $NET1 -p tcp --dport 2222 -j SSH
$IPTABLES -A OUTPUT -s $NET1 -p tcp --sport 22 -j SSH
$IPTABLES -A LogAcceptSSH -m limit --limit 10/s --limit-burst 10 -j LOG
--log-prefix "[Service SSH]: " --log-level info
$IPTABLES -A SSH -j LogAcceptSSH
$IPTABLES -A SSH -j ACCEPT

# Liberar entrada e saida DNS e gera log DNS
$IPTABLES -A INPUT -i $NET1 -p tcp --dport 53 -j DNS
$IPTABLES -A OUTPUT -i $NET1 -p tcp --sport 53 -j DNS
$IPTABLES -A LogAcceptDNS -m limit --limit 10/s --limit-burst 10 -j LOG
--log-prefix "[DNS]: " --log-level info
$IPTABLES -A DNS -j LogAcceptDNS
$IPTABLES -A DNS -j ACCEPT


# Liberar entrada e saida e log http
$IPTABLES -A INPUT -i $NET1 -p tcp --dport 80 -j HTTP
$IPTABLES -A OUTPUT -i $NET1 -p tcp --sport 80 -j HTTP
$IPTABLES -A LogAcceptHTTP -m limit --limit 10/s --limit-burst 10 -j LOG
--log-prefix "[Service HTTP]: " --log-level info
$IPTABLES -A HTTP -j LogAcceptHTTP
$IPTABLES -A HTTP -j ACCEPT

# Liberar entrada e saida e log HTTPs
$IPTABLES -A INPUT -i $NET1 -p tcp --dport 443 -j HTTPs
$IPTABLES -A OUTPUT -i $NET1 -p tcp --sport 443 -j HTTPs
$IPTABLES -A LogAcceptHTTPs -m limit --limit 10/s --limit-burst 10 -j LOG
--log-prefix "[Service HTTps]: " --log-level info
$IPTABLES -A HTTPs -j LogAcceptHTTPs
$IPTABLES -A HTTPS -j ACCEPT

# Rejeitar e registrar trafego bloqueado
$IPTABLES -A INPUT -j LogDrop
$IPTABLES -A OUTPUT -j LogDrop
$IPTABLES -A LogDrop -m limit --limit 10/s --limit-burst 10 -j LOG --log-prefix
"[Bloqueado]: " --log-level info
$IPTABLES -A LogDrop -j DROP
 
